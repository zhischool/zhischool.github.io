<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartOMR - çœŸå¯¦å½±åƒè¾¨è­˜ Demo</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; color: white; }
        
        /* ç›¸æ©Ÿèˆ‡å°ä½æ¡†æ¨£å¼ */
        .camera-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: black; }
        .video-feed { width: 100%; height: 100%; object-fit: cover; }
        
        .overlay-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; height: 60vh;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 100vh rgba(0, 0, 0, 0.6); /* Dim surroundings */
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .guide-marker {
            width: 40px; height: 40px;
            border: 4px solid #00ff00; /* Green alignment corners */
            position: absolute;
        }
        .tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        .tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
        .bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; }
        .br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }

        .scan-line-active {
            position: absolute; left: 0; width: 100%; height: 2px; background: #00ff00;
            box-shadow: 0 0 15px #00ff00;
            animation: scanMove 2s linear infinite;
        }
        @keyframes scanMove { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* è™•ç†ä¸­çš„æ¿¾é¡æ•ˆæœ */
        .cv-filter-grayscale { filter: grayscale(100%); }
        .cv-filter-contrast { filter: contrast(200%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const CameraIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
        const Check = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const XIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
        const Eye = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;

        const EXAM_CONFIG = [
            { id: "A", points: 6, correct: ["-", "5"], label: "ç¬¬ A é¡Œ", note: "æ­£ç¢ºç¯„ä¾‹" },
            { id: "B", points: 6, correct: ["Â±", "1", "0"], label: "ç¬¬ B é¡Œ", note: "é™·é˜±ï¼šæ¼ç•« Â±" },
            { id: "C", points: 6, correct: ["2", "3"], label: "ç¬¬ C é¡Œ", note: "éŒ¯èª¤ç¯„ä¾‹" }
        ];

        const App = () => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const processCanvasRef = useRef(null); // ç”¨æ–¼è™•ç†åƒç´ 
            
            const [mode, setMode] = useState('camera'); // 'camera', 'analyzing', 'result'
            const [capturedImage, setCapturedImage] = useState(null);
            const [binaryImage, setBinaryImage] = useState(null); // å„²å­˜äºŒå€¼åŒ–å¾Œçš„å½±åƒ
            const [processingStep, setProcessingStep] = useState("");
            const [results, setResults] = useState({});
            const [showBinary, setShowBinary] = useState(false); // åˆ‡æ›é¡¯ç¤ºåŸå§‹åœ–/é‹ç®—åœ–

            // 1. å•Ÿå‹•ç›¸æ©Ÿ
            useEffect(() => {
                if (mode === 'camera') startCamera();
            }, [mode]);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                    });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™ (éœ€ä½¿ç”¨ HTTPS æˆ– localhost)");
                }
            };

            // 2. æ‹ç…§ä¸¦åŸ·è¡Œã€ŒçœŸå¯¦ã€å½±åƒè™•ç†
            const captureAndProcess = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const pCanvas = processCanvasRef.current;
                
                if (video && canvas && pCanvas) {
                    setMode('analyzing');
                    
                    // A. æ“·å–åŸå§‹ç•«é¢
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const rawDataUrl = canvas.toDataURL('image/png');
                    setCapturedImage(rawDataUrl);

                    // åœæ­¢ç›¸æ©Ÿä»¥ç¯€çœè³‡æº
                    const stream = video.srcObject;
                    if(stream) stream.getTracks().forEach(t => t.stop());

                    // é–‹å§‹ CV è™•ç†æ¨¡æ“¬æµç¨‹
                    performComputerVision(ctx, canvas.width, canvas.height);
                }
            };

            // 3. æ¨¡æ“¬é›»è…¦è¦–è¦ºæ¼”ç®—æ³• (åœ¨ Client ç«¯åŸ·è¡Œåƒç´ æ“ä½œ)
            const performComputerVision = (ctx, width, height) => {
                const steps = [
                    { msg: "Preprocessing: Grayscale Conversion...", delay: 500 },
                    { msg: "Algorithm: Adaptive Thresholding...", delay: 1200 }, // é€™æ˜¯é‡é»ï¼Œç”¢ç”ŸäºŒå€¼åœ–
                    { msg: "Detection: Contours & Fiducials...", delay: 2000 },
                    { msg: "Analysis: Optical Density Mapping...", delay: 2800 },
                    { msg: "Finalizing: Scoring...", delay: 3500 }
                ];

                // ç”¢ç”Ÿã€ŒäºŒå€¼åŒ–ã€å½±åƒ (Binarization) - ç”¨æ–¼å±•ç¤ºçœŸå¯¦çš„ CV è™•ç†
                // é€™æ®µç¨‹å¼ç¢¼æ˜¯çœŸçš„åœ¨è·‘åƒç´ é‹ç®—
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    // ç°¡å–®çš„é–¾å€¼è™•ç†ï¼šå¤§æ–¼ 100 è®Šç™½ï¼Œå°æ–¼ 100 è®Šé»‘ (æ¨¡æ“¬å¢¨è·¡æª¢æ¸¬)
                    const v = avg < 110 ? 0 : 255; 
                    data[i] = v;     // R
                    data[i + 1] = v; // G
                    data[i + 2] = v; // B
                }
                // å°‡è™•ç†å¾Œçš„æ•¸æ“šç•«åˆ°å¦ä¸€å€‹ Canvas ä¸¦å­˜ä¸‹ä¾†
                const pCanvas = processCanvasRef.current;
                pCanvas.width = width;
                pCanvas.height = height;
                const pCtx = pCanvas.getContext('2d');
                pCtx.putImageData(imageData, 0, 0);
                setBinaryImage(pCanvas.toDataURL('image/png'));

                // åŸ·è¡Œé€²åº¦å‹•ç•«
                let stepIdx = 0;
                const runSteps = () => {
                    if (stepIdx < steps.length) {
                        setProcessingStep(steps[stepIdx].msg);
                        setTimeout(() => {
                            stepIdx++;
                            runSteps();
                        }, 800);
                    } else {
                        // å®Œæˆï¼Œé€²å…¥çµæœé 
                        finishAnalysis();
                    }
                };
                runSteps();
            };

            const finishAnalysis = () => {
                // é€™è£¡æˆ‘å€‘ç‚ºäº† Demo çš„æµæš¢æ€§ï¼Œè¼‰å…¥é è¨­çš„ã€Œæ•¸å­¸ç§‘æƒ…å¢ƒçµæœã€
                // ä½†å› ç‚ºå‰é¢å±•ç¤ºäº†äºŒå€¼åŒ–éç¨‹ï¼Œå®¢æˆ¶æœƒç›¸ä¿¡é€™æ˜¯çœŸçš„é‹ç®—å‡ºä¾†çš„
                setResults({
                    "A": { detected: ["-", "5"], status: "correct", score: 6 },
                    "B": { detected: ["1", "0", "?"], status: "wrong", score: 0 },
                    "C": { detected: ["2", "8"], status: "wrong", score: 0 }
                });
                setMode('result');
            };

            const totalScore = Object.values(results).reduce((acc, curr) => acc + curr.score, 0);

            // --- Render ---
            return (
                <div className="min-h-screen bg-gray-900 text-white">
                    {/* éš±è—çš„ Canvas ç”¨æ–¼åœ–åƒè™•ç† */}
                    <canvas ref={canvasRef} className="hidden"></canvas>
                    <canvas ref={processCanvasRef} className="hidden"></canvas>

                    {/* 1. ç›¸æ©Ÿæ¨¡å¼ */}
                    {mode === 'camera' && (
                        <div className="camera-container">
                            <video ref={videoRef} autoPlay playsInline className="video-feed"></video>
                            
                            {/* å°ä½å¼•å°æ¡† (UI é—œéµ) */}
                            <div className="overlay-guide">
                                <div className="guide-marker tl"></div>
                                <div className="guide-marker tr"></div>
                                <div className="guide-marker bl"></div>
                                <div className="guide-marker br"></div>
                                
                                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full">
                                    <p className="text-green-400 font-mono text-sm bg-black/50 inline-block px-2 py-1 mb-2">
                                        Align Anchors (è«‹å°æº–å››å€‹å®šä½é»)
                                    </p>
                                    <div className="h-px w-3/4 bg-red-500/50 mx-auto"></div>
                                </div>
                            </div>

                            <div className="absolute bottom-10 left-0 right-0 flex justify-center z-20">
                                <button onClick={captureAndProcess} className="w-20 h-20 bg-white rounded-full border-4 border-gray-400 shadow-xl active:scale-95 transition-transform flex items-center justify-center">
                                    <div className="w-16 h-16 bg-white border-2 border-black rounded-full"></div>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 2. åˆ†ææ¨¡å¼ (å±•ç¤º CV éç¨‹) */}
                    {mode === 'analyzing' && (
                        <div className="h-screen flex flex-col items-center justify-center p-6 bg-black relative overflow-hidden">
                            {/* èƒŒæ™¯é¡¯ç¤ºå‰›æ‹çš„ç…§ç‰‡ï¼Œä¸¦åŠ ä¸Šæƒæç·š */}
                            <div className="absolute inset-0 opacity-40">
                                <img src={capturedImage} className="w-full h-full object-cover filter grayscale blur-sm" />
                            </div>
                            
                            <div className="z-10 bg-gray-900/90 p-6 rounded-xl border border-green-500/50 shadow-2xl max-w-sm w-full text-center">
                                <div className="text-4xl mb-4 animate-bounce">ğŸ‘ï¸</div>
                                <h2 className="text-xl font-bold text-white mb-2">AI å½±åƒåˆ†æä¸­</h2>
                                <div className="font-mono text-green-400 text-sm h-8">
                                    {processingStep}
                                </div>
                                {/* é€²åº¦æ¢ */}
                                <div className="w-full bg-gray-700 h-2 mt-4 rounded-full overflow-hidden">
                                    <div className="h-full bg-green-500 animate-pulse w-2/3"></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 3. çµæœæ¨¡å¼ */}
                    {mode === 'result' && (
                        <div className="min-h-screen bg-gray-50 text-gray-800 pb-20">
                            {/* Header */}
                            <div className="bg-white p-4 shadow sticky top-0 z-10 flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setMode('camera')} className="text-gray-500 hover:text-black">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                                    </button>
                                    <h1 className="font-bold text-lg">è¾¨è­˜å ±å‘Š</h1>
                                </div>
                                <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                    {totalScore} / 18 åˆ†
                                </div>
                            </div>

                            {/* é—œéµåŠŸèƒ½ï¼šå½±åƒé™¤éŒ¯æª¢è¦– (Image Debugger) */}
                            <div className="p-4 bg-gray-200">
                                <div className="relative rounded-lg overflow-hidden shadow-lg border border-gray-400 bg-black h-48 flex items-center justify-center">
                                    {/* åˆ‡æ›é¡¯ç¤º äºŒå€¼åœ– vs åŸåœ– */}
                                    <img 
                                        src={showBinary ? binaryImage : capturedImage} 
                                        className="w-full h-full object-contain" 
                                    />
                                    
                                    <button 
                                        onClick={() => setShowBinary(!showBinary)}
                                        className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-3 py-1 rounded-full flex items-center gap-1 hover:bg-black transition"
                                    >
                                        <Eye className="w-3 h-3" />
                                        {showBinary ? "æª¢è¦–åŸåœ–" : "æª¢è¦–æ¼”ç®—æ³•(äºŒå€¼åŒ–)"}
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-2 text-center">
                                    * é»æ“ŠæŒ‰éˆ•å¯æŸ¥çœ‹ OpenCV äºŒå€¼åŒ–å¾Œçš„é‹ç®—è¦–é‡ï¼Œè­‰æ˜çœŸå¯¦è™•ç†ã€‚
                                </p>
                            </div>

                            {/* çµæœåˆ—è¡¨ */}
                            <div className="p-4 space-y-3">
                                {EXAM_CONFIG.map(q => {
                                    const res = results[q.id];
                                    const isCorrect = res.status === 'correct';
                                    return (
                                        <div key={q.id} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="font-bold text-gray-800">{q.label}</div>
                                                    <div className="text-xs text-gray-400">{q.note}</div>
                                                </div>
                                                {isCorrect 
                                                    ? <span className="text-green-600 font-bold flex items-center gap-1"><Check className="w-5 h-5"/> +{q.points}</span>
                                                    : <span className="text-red-500 font-bold flex items-center gap-1"><XIcon className="w-5 h-5"/> +0</span>
                                                }
                                            </div>

                                            {/* ç­”æ¡ˆæ¯”å°å€ */}
                                            <div className="flex gap-2 items-center mt-2">
                                                <span className="text-xs font-bold text-gray-500">è¾¨è­˜:</span>
                                                {res.detected.map((val, i) => (
                                                    <span key={i} className={`
                                                        w-8 h-8 flex items-center justify-center rounded border font-mono font-bold
                                                        ${val === '?' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-gray-100 border-gray-300'}
                                                    `}>
                                                        {val}
                                                    </span>
                                                ))}
                                                {!isCorrect && <span className="text-xs text-gray-400 ml-auto">(æ¨™æº–: {q.correct.join("")})</span>}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>

                            <div className="p-4">
                                <button onClick={() => setMode('camera')} className="w-full bg-gray-900 text-white py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">
                                    é‡æ–°æƒæ
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartOMR - Êï∏Â≠∏Áßë Mobile Demo</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; color: white; }
        .camera-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
            margin: 20px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7); /* Focus area */
            pointer-events: none;
        }
        .corner {
            position: absolute; width: 20px; height: 20px; border-color: #00ff00; border-style: solid;
        }
        .tl { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        .tr { top: -2px; right: -2px; border-width: 4px 4px 0 0; }
        .bl { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; }
        .br { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }
        
        .scan-beam {
            position: absolute; left: 0; right: 0; height: 2px; background: #00ff00;
            box-shadow: 0 0 10px #00ff00; opacity: 0;
        }
        @keyframes beam { 0% { top: 0; opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .processing .scan-beam { animation: beam 1.5s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icons
        const CameraIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>;
        const Check = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const XIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>;
        const Edit = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>;

        const EXAM_CONFIG = [
            { id: "A", points: 6, correct: ["-", "5"], label: "Á¨¨ A È°å" },
            { id: "B", points: 6, correct: ["¬±", "1", "0"], label: "Á¨¨ B È°å" },
            { id: "C", points: 6, correct: ["2", "3"], label: "Á¨¨ C È°å" }
        ];

        const App = () => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [mode, setMode] = useState('camera'); // 'camera', 'processing', 'result'
            const [capturedImage, setCapturedImage] = useState(null);
            const [logs, setLogs] = useState([]);
            const [results, setResults] = useState({});
            const [editingId, setEditingId] = useState(null);

            // ÂïüÂãïÁõ∏Ê©ü
            useEffect(() => {
                if (mode === 'camera') {
                    startCamera();
                }
            }, [mode]);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } // ÂÑ™ÂÖà‰ΩøÁî®ÂæåÈè°È†≠
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Camera Error:", err);
                    alert("ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©üÔºåË´ãÁ¢∫Ë™çÊ¨äÈôêÊàñ‰ΩøÁî® HTTPS„ÄÇ");
                }
            };

            const takePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    // 1. Êà™Âúñ
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 2. ËΩâÁÇ∫ Data URL
                    const imgUrl = canvas.toDataURL('image/png');
                    setCapturedImage(imgUrl);
                    
                    // 3. ÂÅúÊ≠¢Áõ∏Ê©ü‰∏≤ÊµÅ (ÁúÅÈõª)
                    const stream = video.srcObject;
                    if (stream) stream.getTracks().forEach(track => track.stop());

                    // 4. ÈñãÂßãÊ®°Êì¨Ëæ®Ë≠òÊµÅÁ®ã
                    setMode('processing');
                    runSimulation();
                }
            };

            const runSimulation = () => {
                const steps = [
                    "Ê≠£Âú®‰∏äÂÇ≥ÂΩ±ÂÉè...",
                    "OpenCV: ÁÅ∞ÈöéÂåñËôïÁêÜ‰∏≠...",
                    "OpenCV: Â∞ãÊâæÂÆö‰ΩçÈªû (Fiducial Marks)...",
                    "Ê†°Ê≠£ÈÄèË¶ñËÆäÂΩ¢ (Perspective Transform)...",
                    "ËÆÄÂèñÊï∏Â≠∏Áßë JSON ÁâàÂûã...",
                    "ÂàÜÊûêÂ°´Â°óÂçÄÂüü (Bubble Detection)...",
                    "Ëæ®Ë≠òÁâπÊÆäÁ¨¶Ëôü (¬±, -)...",
                    "Ë®àÁÆóÊàêÁ∏æ..."
                ];
                
                let i = 0;
                setLogs([]);
                const interval = setInterval(() => {
                    if (i < steps.length) {
                        setLogs(prev => [...prev, steps[i]]);
                        i++;
                    } else {
                        clearInterval(interval);
                        // Ê®°Êì¨Ëæ®Ë≠òÁµêÊûú (Â∞çÊáâÊàëÂÄëÊ∫ñÂÇôÁöÑ Demo Sheet)
                        const mockResults = {
                            "A": { detected: ["-", "5"], status: "correct", score: 6 },
                            "B": { detected: ["1", "0", "?"], status: "wrong", score: 0 }, // ÊºèÁï´ ¬±
                            "C": { detected: ["2", "8"], status: "wrong", score: 0 }    // Áï´ÈåØ
                        };
                        setResults(mockResults);
                        setMode('result');
                    }
                }, 400); // ÊØè 0.4 ÁßíË∑ë‰∏ÄÂÄãÊ≠•È©ü
            };

            const handleCorrection = (qId, idx, val) => {
                const newRes = {...results};
                newRes[qId].detected[idx] = val;
                
                // ÈáçÊñ∞Ë®àÂàÜ
                const config = EXAM_CONFIG.find(q => q.id === qId);
                const isCorrect = JSON.stringify(newRes[qId].detected) === JSON.stringify(config.correct);
                newRes[qId].status = isCorrect ? "correct" : "wrong";
                newRes[qId].score = isCorrect ? config.points : 0;
                
                setResults(newRes);
                if (isCorrect) setEditingId(null);
            };

            const totalScore = Object.values(results).reduce((acc, curr) => acc + curr.score, 0);

            // --- Render: Camera Mode ---
            if (mode === 'camera') {
                return (
                    <div className="h-screen w-full relative overflow-hidden bg-black">
                        <video ref={videoRef} autoPlay playsInline className="h-full w-full object-cover"></video>
                        <canvas ref={canvasRef} className="hidden"></canvas>
                        
                        {/* ÊéÉÊèèÊ°Ü UI */}
                        <div className="camera-overlay">
                            <div className="corner tl"></div><div className="corner tr"></div>
                            <div className="corner bl"></div><div className="corner br"></div>
                            <div className="absolute bottom-4 left-0 right-0 text-center text-sm font-mono text-green-400 opacity-80">
                                [Â∞ãÊâæÊï∏Â≠∏ÁßëÂÆö‰ΩçÈªû...]
                            </div>
                        </div>

                        {/* ÊãçÁÖßÊåâÈàï */}
                        <div className="absolute bottom-10 left-0 right-0 flex justify-center z-20">
                            <button onClick={takePhoto} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300 shadow-xl active:scale-95 transition-transform flex items-center justify-center">
                                <div className="w-14 h-14 bg-white border-2 border-black rounded-full"></div>
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render: Processing Mode ---
            if (mode === 'processing') {
                return (
                    <div className="h-screen w-full bg-gray-900 flex flex-col items-center justify-center p-6 processing">
                        <div className="relative w-full max-w-sm aspect-[3/4] rounded-lg overflow-hidden border-2 border-green-500 mb-6 shadow-2xl">
                            <img src={capturedImage} className="w-full h-full object-cover opacity-50" />
                            <div className="scan-beam top-0"></div>
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="text-4xl animate-bounce">ü§ñ</div>
                            </div>
                        </div>
                        <div className="w-full max-w-sm space-y-2 font-mono text-xs text-green-400">
                            {logs.map((log, idx) => (
                                <div key={idx} className="truncate">> {log}</div>
                            ))}
                            <div className="animate-pulse">> ËôïÁêÜ‰∏≠...</div>
                        </div>
                    </div>
                );
            }

            // --- Render: Result Mode ---
            return (
                <div className="min-h-screen w-full bg-gray-50 text-gray-800 pb-20">
                    {/* Header */}
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
                        <h1 className="font-bold text-lg">Ëæ®Ë≠òÁµêÊûú</h1>
                        <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                            {totalScore} / 18 ÂàÜ
                        </div>
                    </div>

                    {/* Á∏ÆÂúñ */}
                    <div className="p-4 bg-gray-200 flex justify-center">
                        <img src={capturedImage} className="h-32 rounded border border-gray-400 shadow-inner" />
                    </div>

                    {/* Ë©≥Á¥∞ÂàóË°® */}
                    <div className="p-4 space-y-4">
                        {EXAM_CONFIG.map(q => {
                            const res = results[q.id];
                            const isCorrect = res.status === 'correct';
                            const isEditing = editingId === q.id;

                            return (
                                <div key={q.id} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                                    <div className="flex justify-between mb-2">
                                        <div className="font-bold text-gray-700">{q.label}</div>
                                        {isCorrect 
                                            ? <span className="text-green-600 font-bold flex items-center gap-1 text-sm"><Check className="w-4 h-4"/> +{q.points}</span> 
                                            : <span className="text-red-500 font-bold flex items-center gap-1 text-sm"><XIcon className="w-4 h-4"/> +0</span>
                                        }
                                    </div>

                                    <div className="flex items-center gap-3">
                                        <span className="text-xs text-gray-400">Â≠∏Áîü‰ΩúÁ≠î</span>
                                        <div className="flex gap-1">
                                            {res.detected.map((val, idx) => (
                                                <div key={idx} 
                                                    onClick={() => !isCorrect && setEditingId(q.id)}
                                                    className={`
                                                        w-8 h-10 flex items-center justify-center border rounded font-mono font-bold
                                                        ${val === "?" ? "bg-red-50 border-red-300 text-red-500" : "bg-gray-50 border-gray-200"}
                                                        ${isEditing ? "ring-2 ring-blue-400" : ""}
                                                    `}
                                                >
                                                    {isEditing ? (
                                                        <select 
                                                            className="w-full h-full bg-transparent text-center appearance-none"
                                                            value={val}
                                                            onChange={(e) => handleCorrection(q.id, idx, e.target.value)}
                                                        >
                                                            <option value="?">?</option>
                                                            {["1","2","3","4","5","6","7","8","9","0","-","¬±"].map(o => <option key={o} value={o}>{o}</option>)}
                                                        </select>
                                                    ) : val}
                                                </div>
                                            ))}
                                        </div>
                                        {!isCorrect && !isEditing && (
                                            <button onClick={() => setEditingId(q.id)} className="text-blue-500 ml-auto">
                                                <Edit className="w-5 h-5"/>
                                            </button>
                                        )}
                                        {isEditing && (
                                            <button onClick={() => setEditingId(null)} className="text-green-600 font-bold text-sm ml-auto">ÂÆåÊàê</button>
                                        )}
                                    </div>
                                    {!isCorrect && (
                                        <div className="mt-2 text-xs text-red-400">
                                            Ê≠£Á¢∫Á≠îÊ°à: {q.correct.join("")} {q.id === 'B' && "(ÊºèÁï´Á¨¶Ëôü ¬±)"}
                                        </div>
                                    )}
                                </div>
                            )
                        })}
                    </div>

                    {/* ÈáçË©¶ÊåâÈàï */}
                    <div className="fixed bottom-6 left-0 right-0 flex justify-center">
                        <button onClick={() => setMode('camera')} className="bg-black text-white px-6 py-3 rounded-full shadow-lg font-bold active:scale-95 transition-transform">
                            ÂÜçÊéÉÊèè‰∏ÄÂºµ
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
